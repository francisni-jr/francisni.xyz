<script>import { get_current_component } from "svelte/internal";
import { createEventDispatcher } from "svelte";
import fuzzy from "fuzzy";
import { El } from "../el";
import { Popup } from "../popup";
import { classname } from "../internal";
import { Icon } from "../icon";
export let componentName = "autocomplete";
export let items = [];
export let placeholder = void 0;
export let state = void 0;
export let size = void 0;
export let _slots = $$slots;
export let key = void 0;
export let create = void 0;
export let dismissible = void 0;
export let disabled = void 0;
export let multiple = void 0;
export let readonly = void 0;
export let value = multiple ? [] : void 0;
export let name = void 0;
const dispatch = createEventDispatcher();
const components = [
  { component: get_current_component(), except: ["input", "changed", "created"] },
  ...$$props.components ?? []
];
$:
  getKey = (item) => {
    if (typeof item === "object") {
      if (key) {
        return typeof key === "string" ? item[key] : key(item);
      } else {
        return item;
      }
    } else {
      return item;
    }
  };
let inputEl;
let query = "";
let show = false;
let noResult = false;
let timer;
let cursorPosition = 0;
function onInput(e) {
  if (!show)
    show = true;
  dispatch("input", query);
}
function onKeyDown(e) {
  if (readonly)
    return;
  if (e.key === "Backspace") {
    if (query.length === 0) {
      if (multiple) {
        let currentPosition = cursorPosition;
        value = value.filter((x, index) => index !== cursorPosition);
        cursorPosition = Math.min(currentPosition, value.length - 1);
      } else {
        value = void 0;
      }
    }
  }
  if (e.key == "ArrowLeft") {
    cursorPosition = Math.max(0, cursorPosition - 1);
  } else if (e.key === "ArrowRight") {
    cursorPosition = Math.min(cursorPosition + 1, value.length - 1);
  }
  if (e.key == "Enter") {
    if (create && options.length === 0) {
      onCreate();
    }
  }
}
$:
  cursorPosition = multiple ? value?.length - 1 : 0;
function onCreate() {
  dispatch("created", query);
  query = "";
  show = false;
}
function onFocus() {
  if (readonly)
    return;
  if (disabled)
    return;
  if (!show)
    timer = setTimeout(() => {
      show = true;
    }, 200);
}
function onSelect(item) {
  if (readonly)
    return;
  query = "";
  inputEl.focus();
  if (multiple) {
    if (value.includes(item)) {
      value = value.filter((x) => x !== item);
    } else {
      value = [...value ?? [], getKey(item)];
    }
    dispatch("changed", value);
    clearTimeout(timer);
  } else {
    value = getKey(item);
    show = false;
    dispatch("changed", value);
  }
}
function onBlur(e) {
  timer = setTimeout(() => {
    show = false;
  }, 200);
}
function onClick() {
  if (readonly)
    return;
  if (disabled)
    return;
  if (timer) {
    timer = clearTimeout(timer);
  }
  show = !show;
  if (show)
    inputEl.focus();
}
function onRemove(item) {
  if (multiple) {
    value = value.filter((x) => x !== getKey(item));
  } else {
    value = void 0;
  }
}
$:
  options = fuzzy.filter(
    query,
    items.filter((i) => value !== getKey(i)),
    {
      extract(input) {
        return JSON.stringify(getKey(input));
      }
    }
  ).map((item) => item.original);
$:
  cssProps = {
    state,
    size,
    disabled
  };
$:
  noResult = options.length === 0;
</script>

<El
	{components}
	{...$$restProps}
	{componentName}
	{cssProps}
	{disabled}
	on:click={onClick}
	on:focus={onFocus}>
	{#if Array.isArray(value)}
		{#each value as val, index}
			{@const item = items.find((x) => getKey(x) == val)}
			{#if item}
				<El
					componentName="{componentName}-item"
					cssProps={{ multiple: true, active: cursorPosition === index }}>
					{#if _slots['selected']}
						<slot name="selected" {item} {index}>{item}</slot>
					{:else}
						<slot {item} {index}>{item}</slot>
					{/if}
					{#if dismissible}
						<El componentName="{componentName}-item-remove" on:click={() => onRemove(item)}>
							<Icon name="x" />
						</El>
					{/if}
				</El>
			{/if}
		{/each}
	{:else}
		{@const index = items.findIndex((x) => getKey(x) == value)}
		{#if index > -1}
			{@const item = items[index]}
			{#if item}
				<El componentName="{componentName}-item">
					{#if _slots['selected']}
						<slot name="selected" {item} {index}>{item}</slot>
					{:else}
						<slot {item} {index}>{item}</slot>
					{/if}
				</El>
			{/if}
		{/if}
	{/if}
	<input
		class={classname(`${componentName}-input`)}
		bind:this={inputEl}
		placeholder={value ? undefined : placeholder}
		{disabled}
		{readonly}
		bind:value={query}
		on:blur={onBlur}
		on:blur
		on:focus={onFocus}
		on:focus
		on:click
		on:keydown={onKeyDown}
		on:input={onInput} />
	<Popup autoClose="outside" bind:show componentName="{componentName}-dropdown">
		{#if noResult}
			{#if create}
				<El
					on:click={() => onCreate()}
					componentName="{componentName}-option"
					cssProps={{ create: true }}>
					Create {query}...
				</El>
			{:else}
				<El componentName="{componentName}-option" cssProps={{ noResult: true }}>No result</El>
			{/if}
		{/if}

		{#each options as item, index}
			{@const shouldShow = multiple ? !value?.includes(getKey(item)) : value !== getKey(item)}
			{#if shouldShow}
				<El on:click={() => onSelect(item)} componentName="{componentName}-option">
					<slot {item} {index}>{item}</slot>
				</El>
			{/if}
		{/each}
	</Popup>
</El>

{#if name}
	{#if multiple}
		{#if value}
			<select style="display: none" multiple {name}>
				{#each value as val}
					<option value={val} selected />
				{/each}
			</select>
		{/if}
	{:else}
		<input type="hidden" {name} bind:value />
	{/if}
{/if}
